<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gym Motiv</title>

  <style>
    body {
      margin: 0;
      font-family: system-ui, Arial;
      background: #0b0f19;
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    .card {
      background: #121a2b;
      padding: 22px;
      border-radius: 16px;
      width: 100%;
      max-width: 360px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      text-align: center;
    }
    h2 { margin-top: 0; }
    button {
      width: 100%;
      padding: 14px;
      margin-top: 10px;
      border-radius: 12px;
      border: none;
      font-size: 16px;
      font-weight: bold;
      background: #1e2a45;
      color: white;
      cursor: pointer;
    }
    button.active { background: #1f6b3a; }
    button:disabled { opacity: .6; }
    .status {
      margin-top: 12px;
      font-size: 14px;
      opacity: .9;
    }
  </style>
</head>

<body>
<div class="card">
  <h2>Gym Motiv üí™</h2>

  <!-- USER SELECT -->
  <button id="massBtn">I am Mass</button>
  <button id="gBtn">I am G</button>
  <div class="status" id="userStatus">Not logged in</div>

  <!-- ACTIONS -->
  <button id="sentBtn" disabled>‚úÖ I have sent (I went)</button>
  <button id="receivedBtn" disabled>‚úÖ I have received (partner went)</button>

  <div class="status" id="todayStatus"></div>
  <div class="status"><strong>This week:</strong> <span id="weekCount">0</span> / 4</div>
</div>

<script type="module">
  console.log("JS loaded ‚úÖ");

  /* ---------- FIREBASE IMPORTS ---------- */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getFirestore,
    doc,
    setDoc,
    updateDoc,
    onSnapshot,
    collection,
    getDocs
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  /* ---------- FIREBASE CONFIG ---------- */
  const firebaseConfig = {
    apiKey: "AIzaSyC2XOpkk8J5GgXPphkrJyFXrcgYwta_Dg4",
    authDomain: "gymmotiv-e58d6.firebaseapp.com",
    projectId: "gymmotiv-e58d6",
    storageBucket: "gymmotiv-e58d6.firebasestorage.app",
    messagingSenderId: "36078583703",
    appId: "1:36078583703:web:0a1f12cc58df9048514ed2"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  console.log("Firebase connected ‚úÖ");

  /* ---------- DATE HELPERS ---------- */
  function todayKey() {
    return new Date().toLocaleDateString("en-CA", { timeZone: "Europe/London" });
  }

  function weekKey() {
    const d = new Date();
    d.setHours(0,0,0,0);
    d.setDate(d.getDate() + 3 - (d.getDay() + 6) % 7);
    const week1 = new Date(d.getFullYear(),0,4);
    return d.getFullYear() + "-W" +
      String(1 + Math.round(((d - week1) / 86400000 - 3 + (week1.getDay()+6)%7) / 7)).padStart(2,"0");
  }

  const WEEK = weekKey();
  const TODAY = todayKey();
  const dayRef = doc(db, "weeks", WEEK, "days", TODAY);

  await setDoc(dayRef, {
    massSent: false,
    massReceived: false,
    gSent: false,
    gReceived: false
  }, { merge: true });

  /* ---------- UI ---------- */
  let currentUser = localStorage.getItem("currentUser");

  const massBtn = document.getElementById("massBtn");
  const gBtn = document.getElementById("gBtn");
  const sentBtn = document.getElementById("sentBtn");
  const receivedBtn = document.getElementById("receivedBtn");
  const userStatus = document.getElementById("userStatus");
  const todayStatus = document.getElementById("todayStatus");
  const weekCount = document.getElementById("weekCount");

  function renderUser() {
    massBtn.classList.toggle("active", currentUser === "mass");
    gBtn.classList.toggle("active", currentUser === "g");

    if (currentUser) {
      userStatus.textContent =
        "Logged in as " + (currentUser === "mass" ? "Mass" : "G");
      sentBtn.disabled = false;
      receivedBtn.disabled = false;
    }
  }

  massBtn.onclick = () => {
    currentUser = "mass";
    localStorage.setItem("currentUser", currentUser);
    renderUser();
  };

  gBtn.onclick = () => {
    currentUser = "g";
    localStorage.setItem("currentUser", currentUser);
    renderUser();
  };

  /* ---------- BUTTON ACTIONS ---------- */
  sentBtn.onclick = async () => {
    if (!currentUser) return;

    await updateDoc(dayRef,
      currentUser === "mass"
        ? { massSent: true }
        : { gSent: true }
    );
  };

  receivedBtn.onclick = async () => {
    if (!currentUser) return;

    await updateDoc(dayRef,
      currentUser === "mass"
        ? { massReceived: true }
        : { gReceived: true }
    );
  };

  /* ---------- LIVE LISTENER ---------- */
  function dayComplete(d) {
    return d.massSent && d.massReceived && d.gSent && d.gReceived;
  }

  async function updateWeekCount() {
    const snap = await getDocs(collection(db, "weeks", WEEK, "days"));
    let count = 0;
    snap.forEach(doc => {
      if (dayComplete(doc.data())) count++;
    });
    weekCount.textContent = count;
  }

  onSnapshot(dayRef, async snap => {
    const d = snap.data();
    if (!d) return;

    sentBtn.disabled = currentUser === "mass" ? d.massSent : d.gSent;
    receivedBtn.disabled = currentUser === "mass" ? d.massReceived : d.gReceived;

    todayStatus.textContent = dayComplete(d)
      ? "‚úÖ Gym day confirmed"
      : "‚è≥ Waiting for confirmations";

    await updateWeekCount();
  });

  renderUser();
</script>
</body>
</html>
