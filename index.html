<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gym Motiv</title>

  <style>
    body {
      margin: 0;
      font-family: system-ui, Arial;
      background: #0b0f19;
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .card {
      background: #121a2b;
      padding: 20px;
      border-radius: 16px;
      width: 100%;
      max-width: 440px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    h2 { text-align: center; margin-top: 0; }
    button {
      width: 100%;
      padding: 12px;
      margin-top: 8px;
      border-radius: 10px;
      border: none;
      font-size: 15px;
      font-weight: bold;
      background: #1e2a45;
      color: white;
      cursor: pointer;
    }
    button.active { background: #1f6b3a; }
    button:disabled { opacity: .6; }
    .status { margin-top: 8px; font-size: 14px; }
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
      margin-top: 12px;
    }
    .day {
      background: #0e1526;
      border-radius: 8px;
      padding: 6px;
      text-align: center;
      font-size: 12px;
    }
    .done { background: #1f6b3a; }
    .punishment {
      margin-top: 12px;
      padding: 10px;
      border-radius: 10px;
      background: #241c1c;
      font-weight: bold;
      text-align: center;
    }
  </style>
</head>

<body>
<div class="card">
  <h2>Gym Motiv üí™</h2>

  <button id="massBtn">I am Mass</button>
  <button id="gBtn">I am G</button>
  <div class="status" id="userStatus"></div>

  <button id="sentBtn" disabled>‚úÖ I have sent (I went)</button>
  <button id="receivedBtn" disabled>‚úÖ I have received (partner went)</button>

  <div class="status" id="todayStatus"></div>

  <h3>This Week</h3>
  <div class="calendar" id="calendar"></div>

  <div class="punishment" id="punishmentBox"></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getFirestore, doc, setDoc, updateDoc,
    collection, getDocs, onSnapshot
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  /* ---------- FIREBASE ---------- */
  const firebaseConfig = {
    apiKey: "AIzaSyC2XOpkk8J5GgXPphkrJyFXrcgYwta_Dg4",
    authDomain: "gymmotiv-e58d6.firebaseapp.com",
    projectId: "gymmotiv-e58d6",
    storageBucket: "gymmotiv-e58d6.firebasestorage.app",
    messagingSenderId: "36078583703",
    appId: "1:36078583703:web:0a1f12cc58df9048514ed2"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  /* ---------- DATE HELPERS ---------- */
  function dateKey(d) {
    return d.toLocaleDateString("en-CA", { timeZone: "Europe/London" });
  }

  function isoWeekKey(d = new Date()) {
    const date = new Date(d);
    date.setHours(0,0,0,0);
    date.setDate(date.getDate() + 3 - (date.getDay() + 6) % 7);
    const week1 = new Date(date.getFullYear(), 0, 4);
    return date.getFullYear() + "-W" +
      String(1 + Math.round(((date - week1) / 86400000 - 3 + (week1.getDay()+6)%7) / 7)).padStart(2,"0");
  }

  function mondayOfWeek() {
    const d = new Date();
    const day = (d.getDay() + 6) % 7;
    d.setDate(d.getDate() - day);
    return d;
  }

  const WEEK = isoWeekKey();
  const TODAY = dateKey(new Date());
  const weekRef = collection(db, "weeks", WEEK, "days");
  const dayRef = doc(db, "weeks", WEEK, "days", TODAY);

  await setDoc(dayRef, {
    massSent: false,
    massReceived: false,
    gSent: false,
    gReceived: false
  }, { merge: true });

  /* ---------- USER ---------- */
  let currentUser = localStorage.getItem("currentUser");

  const massBtn = document.getElementById("massBtn");
  const gBtn = document.getElementById("gBtn");
  const sentBtn = document.getElementById("sentBtn");
  const receivedBtn = document.getElementById("receivedBtn");
  const todayStatus = document.getElementById("todayStatus");
  const calendarEl = document.getElementById("calendar");
  const punishmentBox = document.getElementById("punishmentBox");
  const userStatus = document.getElementById("userStatus");

  function renderUser() {
    massBtn.classList.toggle("active", currentUser === "mass");
    gBtn.classList.toggle("active", currentUser === "g");
    userStatus.textContent = currentUser
      ? "Logged in as " + (currentUser === "mass" ? "Mass" : "G")
      : "";
  }

  massBtn.onclick = () => {
    currentUser = "mass";
    localStorage.setItem("currentUser", currentUser);
    renderUser();
  };

  gBtn.onclick = () => {
    currentUser = "g";
    localStorage.setItem("currentUser", currentUser);
    renderUser();
  };

  /* ---------- DAY LOGIC ---------- */
  function massDayComplete(d) {
    return d.massSent && d.gReceived;
  }

  function gDayComplete(d) {
    return d.gSent && d.massReceived;
  }

  sentBtn.onclick = () => {
    updateDoc(dayRef, currentUser === "mass"
      ? { massSent: true }
      : { gSent: true }
    );
  };

  receivedBtn.onclick = () => {
    updateDoc(dayRef, currentUser === "mass"
      ? { massReceived: true }
      : { gReceived: true }
    );
  };

  /* ---------- WEEK RENDER ---------- */
  async function renderWeek() {
    calendarEl.innerHTML = "";
    punishmentBox.textContent = "";

    const snap = await getDocs(weekRef);
    const days = {};
    snap.forEach(d => days[d.id] = d.data());

    let massCount = 0;
    let gCount = 0;

    const monday = mondayOfWeek();

    for (let i = 0; i < 7; i++) {
      const d = new Date(monday);
      d.setDate(monday.getDate() + i);
      const key = dateKey(d);
      const data = days[key];

      const massDone = data && massDayComplete(data);
      const gDone = data && gDayComplete(data);

      if (massDone) massCount++;
      if (gDone) gCount++;

      const div = document.createElement("div");
      div.className = "day";
      div.innerHTML = `
        ${d.toLocaleDateString("en-GB", { weekday: "short" })}<br>
        M ${massDone ? "‚úÖ" : "‚ùå"}<br>
        G ${gDone ? "‚úÖ" : "‚ùå"}
      `;
      calendarEl.appendChild(div);
    }

    if (massCount < 4 && gCount < 4) {
      punishmentBox.textContent = "‚ùå Both missed ‚Äì both owe ¬£10";
    } else if (massCount < 4) {
      punishmentBox.textContent = "‚ùå Mass missed ‚Äì owes G ¬£10";
    } else if (gCount < 4) {
      punishmentBox.textContent = "‚ùå G missed ‚Äì owes Mass ¬£10";
    } else {
      punishmentBox.textContent = "‚úÖ Both hit target ‚Äì no punishment";
    }
  }

  /* ---------- LIVE ---------- */
  onSnapshot(dayRef, snap => {
    const d = snap.data();
    if (!d || !currentUser) return;

    sentBtn.disabled = currentUser === "mass" ? d.massSent : d.gSent;
    receivedBtn.disabled = currentUser === "mass" ? d.massReceived : d.gReceived;

    todayStatus.textContent =
      currentUser === "mass"
        ? (massDayComplete(d) ? "‚úÖ You‚Äôre done for today" : "‚è≥ Your day not confirmed")
        : (gDayComplete(d) ? "‚úÖ You‚Äôre done for today" : "‚è≥ Your day not confirmed");

    renderWeek();
  });

  renderUser();
  renderWeek();
</script>
</body>
</html>
